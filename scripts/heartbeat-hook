#!/bin/bash
# ~/.panopticon/bin/heartbeat-hook
# Called by Claude Code after every tool use with JSON on stdin
#
# This hook receives PostToolUse event data from Claude Code and writes
# rich heartbeat information to enable real-time agent monitoring.

# Don't use set -e - we want the hook to be resilient to failures
# and never break Claude Code execution

# Parse tool info from stdin
TOOL_INFO=$(cat 2>/dev/null || echo '{}')

# Check if jq is available
if ! command -v jq &> /dev/null; then
  echo "Warning: jq not found. Heartbeat hook requires jq to parse tool data." >&2
  exit 0  # Silent failure - don't break Claude Code execution
fi

# Extract tool name and input (truncate input to 100 chars to avoid huge files)
TOOL_NAME=$(echo "$TOOL_INFO" | jq -r '.tool_name // "unknown"' 2>/dev/null || echo "unknown")
TOOL_INPUT=$(echo "$TOOL_INFO" | jq -r '.tool_input | tostring | .[0:100] // ""' 2>/dev/null || echo "")

# Get agent ID from env (set by pan work issue) or tmux session name
# Only use tmux session name if we're actually INSIDE a tmux session ($TMUX is set)
if [ -n "$PANOPTICON_AGENT_ID" ]; then
  AGENT_ID="$PANOPTICON_AGENT_ID"
elif [ -n "$TMUX" ]; then
  AGENT_ID=$(tmux display-message -p '#S' 2>/dev/null)
else
  AGENT_ID="main-cli"
fi
AGENT_ID="${AGENT_ID:-unknown}"

# Get current beads task from cache (if exists)
TASK_CACHE="$HOME/.panopticon/agents/$AGENT_ID/current-task.json"
CURRENT_TASK=""
if [ -f "$TASK_CACHE" ]; then
  CURRENT_TASK=$(jq -r '.title // ""' "$TASK_CACHE" 2>/dev/null || echo "")
fi

# Get git branch (fast, single command) - suppress all errors
GIT_BRANCH=$(git branch --show-current 2>/dev/null || true)
GIT_BRANCH="${GIT_BRANCH:-unknown}"

# Get workspace from pwd
WORKSPACE=$(pwd)

# Ensure heartbeat directory exists
HEARTBEAT_DIR="$HOME/.panopticon/heartbeats"
mkdir -p "$HEARTBEAT_DIR"

# Write heartbeat atomically (write to temp file, then move)
# Use jq to properly escape all strings in the JSON output
TEMP_FILE="$HEARTBEAT_DIR/$AGENT_ID.json.tmp"
jq -n \
  --arg timestamp "$(date -Iseconds)" \
  --arg agent_id "$AGENT_ID" \
  --arg tool_name "$TOOL_NAME" \
  --arg last_action "$TOOL_INPUT" \
  --arg current_task "$CURRENT_TASK" \
  --arg git_branch "$GIT_BRANCH" \
  --arg workspace "$WORKSPACE" \
  --argjson pid $$ \
  '{
    timestamp: $timestamp,
    agent_id: $agent_id,
    tool_name: $tool_name,
    last_action: $last_action,
    current_task: $current_task,
    git_branch: $git_branch,
    workspace: $workspace,
    pid: $pid
  }' > "$TEMP_FILE" 2>/dev/null || true

# Atomic move to avoid race conditions
mv "$TEMP_FILE" "$HEARTBEAT_DIR/$AGENT_ID.json" 2>/dev/null || true

# Always exit successfully - never break Claude Code execution
exit 0
