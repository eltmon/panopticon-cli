# Panopticon Dashboard Dev Container
# Feature workspace: feature-pan-81
# URLs:
#   Frontend: https://feature-pan-81.pan.localhost
#   API: https://api-feature-pan-81.pan.localhost

services:
  # Combined dev container for VS Code attach
  dev:
    build:
      context: .
      dockerfile: Dockerfile
    user: node
    volumes:
      - ../:/workspaces/panopticon:cached
      - npm-cache:/home/node/.npm
    command: sleep infinity
    networks:
      - devnet
      - panopticon

  # Frontend (Vite dev server with HMR)
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
    user: node
    working_dir: /workspaces/panopticon/src/dashboard/frontend
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0"
    volumes:
      # Mount entire src directory for cross-directory imports
      - ../src:/workspaces/panopticon/src:cached
      - npm-cache:/home/node/.npm
      # Named volume to shadow host's node_modules (avoids permission conflicts)
      - frontend-node-modules:/workspaces/panopticon/src/dashboard/frontend/node_modules
    environment:
      - CI=true
      - VITE_API_URL=https://api-feature-pan-81.pan.localhost
    networks:
      - devnet
      - panopticon
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.pan-fe-feature-pan-81.rule=Host(`feature-pan-81.pan.localhost`)"
      - "traefik.http.routers.pan-fe-feature-pan-81.entrypoints=websecure"
      - "traefik.http.routers.pan-fe-feature-pan-81.tls=true"
      - "traefik.http.services.pan-fe-feature-pan-81.loadbalancer.server.port=3010"

  # Backend API server (with watch mode)
  server:
    build:
      context: .
      dockerfile: Dockerfile
    user: node
    working_dir: /workspaces/panopticon/src/dashboard/server
    command: sh -c "npm install && npm run dev"
    volumes:
      # Mount entire src directory for cross-directory imports
      - ../src:/workspaces/panopticon/src:cached
      - npm-cache:/home/node/.npm
      # Named volume to shadow host's node_modules (avoids permission conflicts)
      - server-node-modules:/workspaces/panopticon/src/dashboard/server/node_modules
      # Mount required host paths for workspace/agent management
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ${HOME}/.panopticon:/home/node/.panopticon:ro
      - ${HOME}/projects:/home/node/projects:ro
    environment:
      - NODE_ENV=development
      - PORT=3011
      - LINEAR_API_KEY=${LINEAR_API_KEY}
      - GITHUB_TOKEN=${GITHUB_TOKEN}
    networks:
      - devnet
      - panopticon
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.pan-api-feature-pan-81.rule=Host(`api-feature-pan-81.pan.localhost`)"
      - "traefik.http.routers.pan-api-feature-pan-81.entrypoints=websecure"
      - "traefik.http.routers.pan-api-feature-pan-81.tls=true"
      - "traefik.http.services.pan-api-feature-pan-81.loadbalancer.server.port=3011"

volumes:
  npm-cache:
  frontend-node-modules:
  server-node-modules:

networks:
  devnet:
  panopticon:
    external: true
