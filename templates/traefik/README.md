# Panopticon Traefik Configuration

Traefik reverse proxy for local development with HTTPS.

## Directory Structure

```
~/.panopticon/traefik/
├── docker-compose.yml      # Traefik container definition
├── traefik.yml             # Static configuration
├── dynamic/                # Dynamic routing configs
│   └── panopticon.yml      # Dashboard routing
├── certs/                  # mkcert SSL certificates
│   ├── _wildcard.pan.localhost.pem
│   └── _wildcard.pan.localhost-key.pem
└── README.md               # This file
```

## URLs

| URL | Service |
|-----|---------|
| `https://pan.localhost` | Panopticon Dashboard (Frontend) |
| `https://pan.localhost/api/*` | Panopticon Dashboard (API) |
| `http://localhost:8080` | Traefik Dashboard |

## How It Works

### Static Configuration (`traefik.yml`)
- Defines entry points (HTTP:80, HTTPS:443)
- Enables Traefik dashboard on port 8080
- Configures file provider for dynamic configs
- Sets up TLS with wildcard certificates

### Dynamic Configuration (`dynamic/panopticon.yml`)
- Routes `https://pan.localhost` to dashboard frontend (port 3001)
- Routes `https://pan.localhost/api/*` to dashboard API (port 3002)
- Uses `host.docker.internal` to access host-based services

### Docker Compose
- Runs Traefik v3.0 in a container
- Exposes ports 80, 443, 8080
- Mounts configuration files and certificates
- Uses `panopticon` network for container communication

## Prerequisites

1. **mkcert certificates** must be generated first:
   ```bash
   mkcert "*.pan.localhost" "*.localhost" localhost 127.0.0.1 ::1
   ```
   Certificates should be in `~/.panopticon/traefik/certs/`

2. **DNS/Hosts configuration**:
   - Add to `/etc/hosts`: `127.0.0.1 pan.localhost`
   - Wildcard `*.localhost` resolves automatically on most systems

## Usage

Start Traefik:
```bash
cd ~/.panopticon/traefik
docker-compose up -d
```

Stop Traefik:
```bash
cd ~/.panopticon/traefik
docker-compose down
```

View logs:
```bash
docker logs -f panopticon-traefik
```

## Managed by CLI

These commands are automated via `pan` CLI:
- `pan install` - Sets up Traefik (creates configs, generates certs)
- `pan up` - Starts Traefik container
- `pan down` - Stops Traefik container

## Adding Workspace Routes

Workspace-specific routes should be added as separate YAML files in `dynamic/`:

```yaml
# dynamic/feature-pan-4.yml
http:
  routers:
    workspace-feature-pan-4-frontend:
      rule: "Host(`feature-pan-4.myn.localhost`)"
      service: workspace-feature-pan-4-frontend
      entryPoints:
        - websecure
      tls: {}

  services:
    workspace-feature-pan-4-frontend:
      loadBalancer:
        servers:
          - url: "http://workspace-feature-pan-4-frontend:3000"
```

These are auto-generated by `pan workspace create` and `pan workspace start`.
