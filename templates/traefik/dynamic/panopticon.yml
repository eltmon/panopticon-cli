# Dynamic routing configuration for Panopticon Dashboard
# Routes traffic from pan.localhost to host-based services

http:
  routers:
    # Dashboard Frontend (pan.localhost)
    panopticon-frontend:
      rule: "Host(`pan.localhost`) && !PathPrefix(`/api`)"
      entryPoints:
        - websecure
      service: panopticon-frontend
      tls:
        domains:
          - main: "pan.localhost"
            sans:
              - "*.pan.localhost"

    # Dashboard API (pan.localhost/api/*)
    panopticon-api:
      rule: "Host(`pan.localhost`) && PathPrefix(`/api`)"
      entryPoints:
        - websecure
      service: panopticon-api
      middlewares:
        - api-stripprefix
      tls: {}

  services:
    # Frontend service (running on host:3001)
    panopticon-frontend:
      loadBalancer:
        servers:
          - url: "http://host.docker.internal:3001"

    # API service (running on host:3002)
    panopticon-api:
      loadBalancer:
        servers:
          - url: "http://host.docker.internal:3002"

  middlewares:
    # Strip /api prefix before forwarding to API service
    api-stripprefix:
      stripPrefix:
        prefixes:
          - "/api"

tls:
  certificates:
    - certFile: /etc/traefik/certs/_wildcard.pan.localhost.pem
      keyFile: /etc/traefik/certs/_wildcard.pan.localhost-key.pem
