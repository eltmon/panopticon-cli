# Agent Instructions: PAN-121

You are an autonomous coding agent working on GitHub issue PAN-121: **Redesign Settings Page with Stitch: Complete Model Configuration UX**

## Issue URL
https://github.com/eltmon/panopticon-cli/issues/121

## CRITICAL: Read CLAUDE.md First

Before starting ANY work, read the workspace CLAUDE.md for critical project guidelines:
- Model tracking in commits (MUST include your model ID in Co-Authored-By)
- Never defer work - complete ALL tasks in scope
- Never use execSync in dashboard/lib code
- Use messageAgent() for agent communication, not raw tmux

## Workspace Structure

```
/home/eltmon/projects/panopticon/workspaces/feature-pan-121/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ dashboard/
â”‚   â”‚   â”œâ”€â”€ frontend/   â† React + Vite frontend
â”‚   â”‚   â””â”€â”€ server/     â† Express API server
â”‚   â”œâ”€â”€ lib/            â† Shared library code
â”‚   â””â”€â”€ cli/            â† CLI commands
â”œâ”€â”€ packages/shared/    â† Shared types
â”œâ”€â”€ .beads/             â† Task tracking database
â””â”€â”€ CLAUDE.md           â† Project guidelines
```

## Dev Environment (CONTAINERIZED)

This workspace runs in Docker containers with hot reload.

| Service | URL | Auto-reload |
|---------|-----|-------------|
| Frontend | https://feature-pan-121.pan.localhost | âœ… Vite HMR |
| API | https://api-feature-pan-121.pan.localhost | âœ… tsx watch |

**Containers are already running.** Code changes are picked up automatically.

To check container logs:
```bash
docker compose -f .devcontainer/docker-compose.devcontainer.yml logs frontend --tail=50
docker compose -f .devcontainer/docker-compose.devcontainer.yml logs server --tail=50
```

## Beads Task Tracking (50 Tasks)

This issue has 50 beads tracking all implementation work. **Use beads to guide your work:**

```bash
# Find unblocked tasks ready to work on
bd ready

# Get details on a specific task
bd show <bead-id>

# Start working on a task
bd update <bead-id> --status in_progress

# Add progress notes (survives context compaction!)
bd comments add <bead-id> "Implemented X, moving to Y"

# Complete a task
bd close <bead-id> --reason "Implemented and tested"

# Sync changes to git
bd sync
```

**CRITICAL**: Add comments as you work - they persist across session compaction.

## Issue Summary

The current settings page (from PAN-118) has critical UX gaps:

### Critical Problems to Fix

1. **Agent Spawning Uses Wrong CLI** (`src/lib/agents.ts:396,401`)
   - Uses `claude` CLI instead of `ccr` (claude-code-router)
   - Non-Anthropic models are silently ignored
   - Fix: Use `ccr` for non-Anthropic models, `claude` for Anthropic

2. **Preset Selection Shows No Detail**
   - Users can't see the actual 20+ work type â†’ model mappings

3. **Advanced Overrides Don't Show Preset Defaults**
   - `presetModels` parameter is always empty

4. **Configure Override Does Nothing**
   - Button just logs to console, no modal

### Implementation Phases

1. **Phase 1: CCR Integration** - Create src/lib/ccr.ts, fix agent spawning
2. **Phase 2: Backend API** - Add preset and available-models endpoints
3. **Phase 3: Stitch Design** - Design modals and components
4. **Phase 4: Frontend Components** - Implement UI components
5. **Phase 5: E2E Testing** - Test all workflows

## Testing

Run tests before committing:
```bash
# Frontend tests
cd src/dashboard/frontend && npm test

# Server tests
cd src/dashboard/server && npm test

# All tests from root
npm test
```

For E2E tests:
```bash
cd src/dashboard/frontend && npm run test:e2e
```

## When Complete

1. **Commit all changes** with Co-Authored-By line:
   ```bash
   git add -A
   git commit -m "feat(settings): redesign settings page with full model configuration UX (PAN-121)

   - Add CCR module for proper CLI routing
   - Implement preset preview modal
   - Add override configuration modal
   - Fix WorkTypeTable to show preset defaults
   - Add API key validation

   Co-Authored-By: Claude <your-model-id> <noreply@anthropic.com>"
   ```

2. **Push the branch**:
   ```bash
   git push -u origin feature/pan-121
   ```

3. **Create PR**:
   ```bash
   gh pr create --title "PAN-121: Redesign Settings Page with Stitch" --body "## Summary
   - [Implementation details]

   ## Test Plan
   - [Testing done]

   ğŸ¤– Generated with Claude Code"
   ```

4. **Close beads and sync**:
   ```bash
   bd sync
   ```

5. **Notify completion**:
   ```bash
   echo "PAN-121 complete - PR created" >> .agent-progress.md
   ```

Work autonomously until complete. Create PR but do NOT merge.
