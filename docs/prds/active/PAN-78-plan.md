# PAN-78: Integrate claude-code-router for multi-model support

## Status: Planning Complete

## Overview

Integrate [claude-code-router](https://github.com/musistudio/claude-code-router) to enable Panopticon to use multiple AI providers (OpenAI, Google, Z.AI) alongside Anthropic models. Panopticon will fully own and manage the router configuration, providing a settings UI for model selection and API key management.

## Decisions Made

### 1. Configuration Ownership
**Decision**: Panopticon completely owns `~/.claude-code-router/config.json`
- Panopticon generates and overwrites the entire config file
- Users manage everything via dashboard UI
- Simpler approach, avoids config conflicts
- Users who want manual control can edit before `pan sync` regenerates it

### 2. Implementation Scope
**Decision**: Full scope implementation (all features in issue)
- Complete settings UI with all sections:
  - Specialist agent models (Review, Test, Merge)
  - Planning agent model
  - Task complexity models (trivial/simple/medium/complex/expert)
  - API keys management (OpenAI, Google AI, Z.AI)
- All work in single PR for cohesive feature

### 3. API Key Storage
**Decision**: Store in `~/.panopticon/settings.json` (TOML format)
- Plain text TOML file, consistent with existing Linear API key approach
- Simple implementation, no external dependencies
- Users responsible for file permissions (document this)
- Future enhancement: migrate to system keychain

### 4. Complexity Routing
**Decision**: Add UI fields now, defer routing logic to PAN-75
- Settings UI includes complexity level dropdowns
- Configuration stored in settings.json
- Actual model routing based on complexity deferred to PAN-75
- Allows planning the full UX now without blocking on routing logic

## Architecture

### Configuration Files

```
~/.panopticon/
├── settings.json          # New: Model selection + API keys
├── cloister.toml          # Existing: Specialist config (no changes needed)
└── config.toml            # Existing: General config (no changes needed)

~/.claude-code-router/
└── config.json            # Generated by Panopticon (owned completely)
```

### Settings Schema (settings.json)

```json
{
  "models": {
    "specialists": {
      "review_agent": "claude-sonnet-4-5",
      "test_agent": "claude-haiku-4-5",
      "merge_agent": "claude-sonnet-4-5"
    },
    "planning_agent": "claude-opus-4-5",
    "complexity": {
      "trivial": "claude-haiku-4-5",
      "simple": "claude-haiku-4-5",
      "medium": "claude-sonnet-4-5",
      "complex": "claude-sonnet-4-5",
      "expert": "claude-opus-4-5"
    }
  },
  "api_keys": {
    "openai": "sk-...",
    "google": "AIza...",
    "zai": "..."
  }
}
```

### Supported Models (Initial Release)

**Anthropic (via Claude Code / Claude API)**
- `claude-opus-4-5` - Most capable model
- `claude-sonnet-4-5` - Balanced model (default)
- `claude-haiku-4-5` - Fast, efficient model

**OpenAI**
- `gpt-5.2-codex` - Agentic coding
- `o3-deep-research` - Deep research
- `gpt-4o` - Fast general model
- `gpt-4o-mini` - Efficient model

**Google (Gemini)**
- `gemini-3-pro-preview` - High capability
- `gemini-3-flash-preview` - Fast model

**Z.AI**
- `glm-4.7` - Standard model
- `glm-4.7-flash` - Fast model

### Router Config Generation

Panopticon will generate `~/.claude-code-router/config.json` based on:
1. Model selections from settings UI
2. API keys from settings.json
3. Default routing rules (which model for which agent type)

Example generated config structure:
```json
{
  "providers": [
    {
      "name": "anthropic",
      "baseURL": "https://api.anthropic.com/v1",
      "apiKey": "$ANTHROPIC_API_KEY",
      "models": ["claude-opus-4-5", "claude-sonnet-4-5", "claude-haiku-4-5"]
    },
    {
      "name": "openai",
      "baseURL": "https://api.openai.com/v1",
      "apiKey": "${OPENAI_API_KEY}",
      "models": ["gpt-5.2-codex", "o3-deep-research", "gpt-4o", "gpt-4o-mini"]
    }
  ],
  "router": {
    "specialist-review-agent": { "model": "claude-sonnet-4-5" },
    "specialist-test-agent": { "model": "claude-haiku-4-5" },
    "specialist-merge-agent": { "model": "claude-sonnet-4-5" },
    "planning-agent": { "model": "claude-opus-4-5" }
  }
}
```

## UI Design

Generated via Stitch MCP server:
- **Screen ID**: `c36617e3aad249b38617056ba7bf8781`
- **Project**: `projects/7429816648963385369` (Panopticon Agent Orchestration Dashboard)
- **Screenshot**: [View in Stitch](https://lh3.googleusercontent.com/aida/AOfcidUBvLtLhR1KYqgmMZr1b0bBXKzFw-W8VUeFReYQpxRDQVWnbla9hDvG012xTjleZkUKoZ7ARDVwJr-iWbVDWLbu0TpQaei8X0Et-aiUjQFG-KYzB__IloExbQ_AsfXGr2AnUV2ZMXvgR2OedGBrXVCDgtQCgTMdKP_73imxoiwaCk2kaInfIFPFTDtnU6V0ku3irxru0hQk1liMnyPnk7vv_SUU_snWlVS_aNKkOihqftokP65FeBxnGh0)

### UI Layout

1. **Settings Tab** - New tab in dashboard navigation
2. **Four Main Sections**:
   - Specialist Agent Models (3 dropdowns)
   - Planning Agent Model (1 dropdown)
   - Task Complexity Models (5 dropdowns)
   - API Keys Management (3 masked inputs + edit buttons)
3. **Save Changes Button** - Applies all settings

## Implementation Tasks

See beads tasks created below for detailed breakdown.

### Phase 1: Backend Infrastructure
1. Create settings.json schema and management functions
2. Add claude-code-router installation to `pan install`
3. Add claude-code-router check/install to `pan sync`
4. Implement config generator (settings.json → router config.json)

### Phase 2: Frontend UI
5. Generate React code from Stitch design (use MCP server)
6. Create SettingsPage component (integrate Stitch code)
7. Implement model dropdowns with provider grouping
8. Implement API key management UI (masked inputs + edit)
9. Add settings tab to dashboard navigation

### Phase 3: Integration
10. Wire up save functionality (UI → settings.json → router config)
11. Model dropdown options filtered by available API keys
12. Update agent spawning to use configured models

### Phase 4: Testing & Documentation
13. E2E test: Install router, configure models, spawn agent
14. Document security considerations (file permissions)
15. Update README with multi-model support section

## Agent Spawning Changes

Current flow:
```typescript
spawnAgent({ model: 'sonnet', ... }) // Hardcoded Anthropic model
```

New flow:
```typescript
// Load model from settings based on agent type
const settings = loadSettings();
const model = settings.models.specialists.review_agent; // e.g., "gpt-5.2-codex"
spawnAgent({ model, ... })
```

The `model` parameter will now reference models from any provider, and claude-code-router will handle the routing.

## Files to Modify

### New Files
- `src/lib/settings.ts` - Settings management (load/save/validate)
- `src/lib/router-config.ts` - Generate claude-code-router config
- `src/dashboard/frontend/src/components/SettingsPage.tsx` - Settings UI
- `src/dashboard/server/routes/settings.ts` - Settings API endpoints

### Modified Files
- `src/cli/commands/install.ts` - Add router installation
- `src/cli/commands/sync.ts` - Add router check/install
- `src/lib/agents.ts` - Use configured models when spawning
- `src/lib/cloister/*.ts` - Use configured specialist models
- `src/dashboard/frontend/src/App.tsx` - Add settings tab
- `src/dashboard/server/index.ts` - Mount settings routes

## Security Considerations

1. **File Permissions**: Document that users should `chmod 600 ~/.panopticon/settings.json`
2. **Environment Variables**: Support `$VAR_NAME` syntax for API keys (alternative to storing plain text)
3. **API Key Display**: Never show full keys in UI (mask with dots, show last 4 chars only)
4. **Config Regeneration**: Warn users that manually editing router config will be overwritten

## Future Enhancements (Out of Scope)

- System keychain integration (PAN-XX)
- Per-project model overrides (PAN-XX)
- Cost tracking per provider (PAN-XX)
- Model performance analytics (PAN-XX)
- Automatic model selection based on context length (PAN-75)

## Acceptance Criteria Checklist

- [ ] `pan install` installs claude-code-router
- [ ] `pan sync` checks/installs claude-code-router if missing
- [ ] Dashboard has settings page for model configuration
- [ ] Can configure model per specialist agent
- [ ] Can configure planning agent model
- [ ] Can configure models for task complexity levels
- [ ] Can add/edit/remove API keys for providers
- [ ] Model dropdowns only show models for which API keys are configured
- [ ] Configuration persists across restarts
- [ ] Changes apply to newly spawned agents
- [ ] Stitch UI design integrated into React components

## Related Issues

- PAN-75: Task complexity-based model routing (implements actual routing logic)

## Sources

- [claude-code-router GitHub](https://github.com/musistudio/claude-code-router)
- [claude-code-router Documentation](https://musistudio.github.io/claude-code-router/)
